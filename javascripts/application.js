// Generated by CoffeeScript 1.3.3
(function() {
  var copyHomeMenu, endCoords, getHomePosition, getTransitionTime, homeX, homeY, info, movementDuration, movementDurationTimeout, pan, prevX, prevY, returnHome, setTransformOrigin, sizeHome, startCoords, transitionTime, workLinks, _counter, _moveToElement, _panMax, _setTimer, _sizeHome;

  transitionTime = 0;

  homeX = 0;

  homeY = 0;

  prevX = false;

  prevY = false;

  startCoords = {};

  endCoords = {};

  movementDuration = 0;

  movementDurationTimeout = null;

  $(function() {
    getTransitionTime();
    setTransformOrigin();
    getHomePosition();
    copyHomeMenu();
    sizeHome();
    workLinks();
    returnHome();
    pan();
    return info();
  });

  getTransitionTime = function() {
    transitionTime = $("#transition-time").css("transition").split(" ")[1];
    return transitionTime = transitionTime.match(/ms$/) ? parseInt(trantisionTime.replace(/ms$/, ""), 10) : parseFloat(transitionTime.replace(/s$/, ""), 10) * 1000;
  };

  setTransformOrigin = function() {
    var x, y;
    x = $("#wrapper").width() / 2;
    y = $("#wrapper").height() / 2;
    return $("#zoom-wrapper").transformOrigin("" + x + "px " + y + "px");
  };

  getHomePosition = function() {
    var position;
    position = $("#home").position();
    homeX = position.left + $(window).width() / 2;
    return homeY = position.top + $(window).height() / 2;
  };

  copyHomeMenu = function() {
    var menu;
    if ($("#fixed-menu ul").length) {
      return;
    }
    menu = $("#home ul").clone();
    return $("#fixed-menu h1").after(menu);
  };

  sizeHome = function() {
    _sizeHome();
    return $(window).resize(function() {
      return _sizeHome();
    });
  };

  _sizeHome = function() {
    $("#home").outerWidth($(window).width());
    return $("#home").outerHeight($(window).height());
  };

  workLinks = function() {
    return $("body").on("click", "ul.work-links a", function(e) {
      var target;
      e.preventDefault();
      target = $("#" + ($(e.target).data("target")));
      _moveToElement(target);
      return $("#home .return-home").show();
    });
  };

  returnHome = function() {
    return $("body").on("click", ".return-home", function(e) {
      $("#home .return-home").hide();
      return _moveToElement($("#home"));
    });
  };

  pan = function() {
    $("body").on("mousedown", function(e) {
      if ($("#stage").hasClass("animating") || $(e.target).closest("#home").length || $(e.target).closest("a").length || $(e.target).closest("img").length || $(e.target).closest("#fixed-menu").length) {
        return;
      }
      $("#stage").stop(true).addClass("panning");
      prevX = false;
      prevY = false;
      startCoords.x = e.pageX;
      startCoords.y = e.pageY;
      movementDuration = 0;
      return _setTimer();
    });
    $("body").on("mouseup", function(e) {
      var deltaX, deltaY, distance, distanceTraveled, maxDistance, maxSpeed, maxxedCoords, newX, newY, pos, slope, speed, xTravel, yTravel;
      if ($(e.target).closest("#home").length || $("#stage").hasClass("animating")) {
        return;
      }
      if (!$("#stage").hasClass("panning")) {
        return;
      }
      $("#stage").removeClass("panning");
      clearTimeout(movementDurationTimeout);
      endCoords.x = e.pageX;
      endCoords.y = e.pageY;
      xTravel = endCoords.x - startCoords.x;
      yTravel = (endCoords.y - startCoords.y) * -1;
      slope = xTravel === 0 ? 100 : yTravel / xTravel;
      distanceTraveled = Math.sqrt(xTravel * xTravel + yTravel * yTravel);
      speed = ((distanceTraveled / movementDuration) * 1000) || 0;
      maxSpeed = 20000;
      maxDistance = 800;
      distance = (speed * maxDistance) / maxSpeed;
      deltaX = distance / (Math.sqrt(slope * slope + 1));
      if (xTravel < 0) {
        deltaX = deltaX * -1;
      }
      deltaY = slope * deltaX;
      pos = $("#stage").position();
      newX = pos.left + deltaX;
      newY = pos.top - deltaY;
      maxxedCoords = _panMax(newX, newY);
      if (speed > 700) {
        return $("#stage").addClass("momentum").animate({
          top: maxxedCoords[1],
          left: maxxedCoords[0]
        }, 1000, "easeOutQuint", function() {
          return $("#stage").removeClass("momentum");
        });
      }
    });
    return $("body").on("mousemove", function(e) {
      var currentPos, deltaX, deltaY, maxxedCoords, newX, newY;
      if (!$("#stage").hasClass("panning")) {
        return;
      }
      currentPos = $("#stage").position();
      if ((prevX != null) && (prevY != null) && prevX !== false && prevY !== false) {
        deltaX = e.pageX - prevX;
        deltaY = e.pageY - prevY;
        newX = currentPos.left + deltaX;
        newY = currentPos.top + deltaY;
        maxxedCoords = _panMax(newX, newY);
        $("#stage").css({
          top: maxxedCoords[1],
          left: maxxedCoords[0]
        });
      }
      prevX = e.pageX;
      return prevY = e.pageY;
    });
  };

  _setTimer = function() {
    return movementDurationTimeout = setTimeout(_counter, 1);
  };

  _counter = function() {
    movementDuration++;
    return _setTimer();
  };

  info = function() {
    $("body").on("mouseenter", ".test", function(e) {
      var text, title, year;
      title = $(this).data("title");
      year = $(this).data("year");
      text = $(this).data("text");
      $("#info").hide().empty().append("<h1>" + title + "</h1>\n<h2>" + year + "</h2>\n<div class=\"text\">" + text + "</div>");
      return $("#info").stop(true, true).fadeIn();
    });
    return $("body").on("mouseleave", ".test", function(e) {
      return $("#info").stop(true, true).fadeOut();
    });
  };

  _moveToElement = function(el) {
    var centerOfElementX, centerOfElementY, element, fieldX, fieldY, height, isHome, position, returnLink, translateString, width,
      _this = this;
    element = $(el);
    position = element.position();
    width = element.width();
    height = element.height();
    isHome = element.attr("id") === "home";
    centerOfElementX = Math.round(position.left + width / 2);
    centerOfElementY = Math.round(position.top + height / 2);
    if (isHome) {
      fieldX = 0;
      fieldY = 0;
    } else {
      fieldX = centerOfElementX - homeX;
      fieldY = centerOfElementY - homeY;
    }
    translateString = "translate(" + (fieldX * -1) + "px, " + (fieldY * -1) + "px)";
    $("#zoom-wrapper").addClass("zoomed-out");
    $("#stage").addClass("animating").transform("" + translateString);
    setTimeout(function() {
      return $("#zoom-wrapper").removeClass("zoomed-out");
    }, transitionTime / 2);
    setTimeout(function() {
      return $("#stage").removeClass("animating");
    }, transitionTime);
    returnLink = $("#fixed-menu");
    if (isHome) {
      return returnLink.animate({
        opacity: 0
      }, transitionTime / 2, function() {
        return returnLink.hide();
      });
    } else {
      return setTimeout(function() {
        returnLink.show().css({
          opacity: 0
        });
        return returnLink.animate({
          opacity: 1
        }, transitionTime / 2);
      }, transitionTime);
    }
  };

  _panMax = function(newX, newY) {
    var maxX, maxY, padding;
    padding = 20;
    maxX = ($("#stage").width() - $(window).width()) * -1 - padding;
    maxY = ($("#stage").height() - $(window).height()) * -1 - padding;
    if (newX > padding) {
      newX = padding;
    }
    if (newY > padding) {
      newY = padding;
    }
    if (newX < maxX) {
      newX = maxX;
    }
    if (newY < maxY) {
      newY = maxY;
    }
    return [newX, newY];
  };

  jQuery.fn.transform = function(args) {
    return $(this).css({
      "-webkit-transform": args,
      "-moz-transform": args,
      "transform": args
    });
  };

  jQuery.fn.transformOrigin = function(args) {
    return $(this).css({
      "-webkit-transform-origin": args,
      "-moz-transform-origin": args,
      "-ms-transform-origin": args,
      "-o-transform-origin": args,
      "transform-origin": args
    });
  };

}).call(this);
