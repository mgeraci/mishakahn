// Generated by CoffeeScript 1.3.3
(function() {
  var clickNavigation, getInitialValues, homeX, homeY, info, pan, resizeFunction, setSizeAndResize, setTransformOrigin, sizeHome, transitionTime;

  transitionTime = 1200;

  homeX = 0;

  homeY = 0;

  $(function() {
    getInitialValues();
    setSizeAndResize();
    clickNavigation.initialize();
    pan.initialize();
    return info.initialize();
  });

  getInitialValues = function() {
    var menu, position;
    transitionTime = $("#transition-time").css("transition").split(" ")[1];
    transitionTime = transitionTime.match(/ms$/) ? parseInt(trantisionTime.replace(/ms$/, ""), 10) : parseFloat(transitionTime.replace(/s$/, ""), 10) * 1000;
    position = $("#home").position();
    homeX = position.left + $(window).width() / 2;
    homeY = position.top + $(window).height() / 2;
    if ($("#fixed-menu ul").length) {
      return;
    }
    menu = $("#home ul").clone();
    return $("#fixed-menu h1").after(menu);
  };

  setSizeAndResize = function() {
    var debouncedResizeFunction;
    resizeFunction();
    debouncedResizeFunction = _.debounce(resizeFunction, 100);
    return $(window).resize(function() {
      return resizeFunction();
    });
  };

  resizeFunction = function() {
    var height, width;
    width = $(window).width();
    height = $(window).height();
    sizeHome(width, height);
    return setTransformOrigin(width, height);
  };

  sizeHome = function(width, height) {
    $("#home").outerWidth(width);
    return $("#home").outerHeight(height);
  };

  setTransformOrigin = function(width, height) {
    return $("#zoom-wrapper").transformOrigin("" + (width / 2) + "px " + (height / 2) + "px");
  };

  clickNavigation = {
    initialize: function() {
      var _this = this;
      $("body").on("click", "ul.work-links a", function(e) {
        return _this.goToPiece(e);
      });
      return $("body").on("click", ".return-home", function(e) {
        return _this.returnHome();
      });
    },
    goToPiece: function(e) {
      var target;
      e.preventDefault();
      target = $("#" + ($(e.target).data("target")));
      this.moveToElement(target);
      return $("#home .return-home").show();
    },
    returnHome: function() {
      $("#home .return-home").hide();
      return this.moveToElement($("#home"));
    },
    moveToElement: function(el) {
      var centerOfElementX, centerOfElementY, element, fieldX, fieldY, height, isHome, position, returnLink, translateString, width,
        _this = this;
      element = $(el);
      position = element.position();
      width = element.width();
      height = element.height();
      isHome = element.attr("id") === "home";
      centerOfElementX = Math.round(position.left + width / 2);
      centerOfElementY = Math.round(position.top + height / 2);
      if (isHome) {
        fieldX = 0;
        fieldY = 0;
      } else {
        fieldX = centerOfElementX - homeX;
        fieldY = centerOfElementY - homeY;
      }
      translateString = "translate(" + (fieldX * -1) + "px, " + (fieldY * -1) + "px)";
      $("#zoom-wrapper").addClass("zoomed-out");
      $("#stage").addClass("animating").transform("" + translateString);
      setTimeout(function() {
        return $("#zoom-wrapper").removeClass("zoomed-out");
      }, transitionTime / 2);
      setTimeout(function() {
        return $("#stage").removeClass("animating");
      }, transitionTime);
      returnLink = $("#fixed-menu");
      if (isHome) {
        return returnLink.animate({
          opacity: 0
        }, transitionTime / 2, function() {
          return returnLink.hide();
        });
      } else {
        return setTimeout(function() {
          returnLink.show().css({
            opacity: 0
          });
          return returnLink.animate({
            opacity: 1
          }, transitionTime / 2);
        }, transitionTime);
      }
    }
  };

  pan = {
    prevX: false,
    prevY: false,
    startCoords: {},
    endCoords: {},
    movementDuration: 0,
    movementDurationTimeout: null,
    mouseDown: function(e) {
      if ($("#stage").hasClass("animating") || $(e.target).closest("#home").length || $(e.target).closest("a").length || $(e.target).closest("img").length || $(e.target).closest("#fixed-menu").length) {
        return;
      }
      $("#stage").stop(true).addClass("panning");
      this.prevX = false;
      this.prevY = false;
      this.startCoords.x = e.pageX;
      this.startCoords.y = e.pageY;
      this.movementDuration = 0;
      return this.setTimer();
    },
    mouseUp: function(e) {
      var deltaX, deltaY, distance, distanceTraveled, maxDistance, maxSpeed, maxxedCoords, newX, newY, pos, slope, speed, xTravel, yTravel;
      if ($(e.target).closest("#home").length || $("#stage").hasClass("animating")) {
        return;
      }
      if (!$("#stage").hasClass("panning")) {
        return;
      }
      $("#stage").removeClass("panning");
      clearTimeout(this.movementDurationTimeout);
      this.endCoords.x = e.pageX;
      this.endCoords.y = e.pageY;
      xTravel = this.endCoords.x - this.startCoords.x;
      yTravel = (this.endCoords.y - this.startCoords.y) * -1;
      slope = xTravel === 0 ? 100 : yTravel / xTravel;
      distanceTraveled = Math.sqrt(xTravel * xTravel + yTravel * yTravel);
      speed = ((distanceTraveled / this.movementDuration) * 1000) || 0;
      maxSpeed = 20000;
      maxDistance = 800;
      distance = (speed * maxDistance) / maxSpeed;
      deltaX = distance / (Math.sqrt(slope * slope + 1));
      if (xTravel < 0) {
        deltaX = deltaX * -1;
      }
      deltaY = slope * deltaX;
      pos = $("#stage").position();
      newX = pos.left + deltaX;
      newY = pos.top - deltaY;
      maxxedCoords = this.panMax(newX, newY);
      if (speed > 700) {
        return $("#stage").addClass("momentum").animate({
          top: maxxedCoords[1],
          left: maxxedCoords[0]
        }, 1000, "easeOutQuint", function() {
          return $("#stage").removeClass("momentum");
        });
      }
    },
    mouseMove: function() {
      var currentPos, deltaX, deltaY, maxxedCoords, newX, newY;
      if (!$("#stage").hasClass("panning")) {
        return;
      }
      currentPos = $("#stage").position();
      if ((this.prevX != null) && (this.prevY != null) && this.prevX !== false && this.prevY !== false) {
        deltaX = e.pageX - this.prevX;
        deltaY = e.pageY - this.prevY;
        newX = currentPos.left + deltaX;
        newY = currentPos.top + deltaY;
        maxxedCoords = this.panMax(newX, newY);
        $("#stage").css({
          top: maxxedCoords[1],
          left: maxxedCoords[0]
        });
      }
      this.prevX = e.pageX;
      return this.prevY = e.pageY;
    },
    setTimer: function() {
      return this.movementDurationTimeout = setTimeout(this.counter, 1);
    },
    counter: function() {
      this.movementDuration++;
      return this.setTimer();
    },
    panMax: function(newX, newY) {
      var maxX, maxY, padding;
      padding = 20;
      maxX = ($("#stage").width() - $(window).width()) * -1 - padding;
      maxY = ($("#stage").height() - $(window).height()) * -1 - padding;
      if (newX > padding) {
        newX = padding;
      }
      if (newY > padding) {
        newY = padding;
      }
      if (newX < maxX) {
        newX = maxX;
      }
      if (newY < maxY) {
        newY = maxY;
      }
      return [newX, newY];
    },
    initialize: function() {
      var _this = this;
      $("body").on("mousedown", function(e) {
        return _this.mouseDown();
      });
      $("body").on("mouseup", function(e) {
        return _this.mouseUp();
      });
      return $("body").on("mousemove", function(e) {
        return _this.mouseMove();
      });
    }
  };

  info = {
    initialize: function() {
      var _this = this;
      $("body").on("mouseenter", ".test", function(e) {
        return _this.showHovercard(e.currentTarget);
      });
      return $("body").on("mouseleave", ".test", function(e) {
        return _this.hideHovercard();
      });
    },
    showHovercard: function(el) {
      var params;
      params = {
        title: $(el).data("title"),
        year: $(el).data("year"),
        text: $(el).data("text")
      };
      $("#info").hide().empty().append(this.template(params));
      return $("#info").stop(true, true).fadeIn();
    },
    hideHovercard: function() {
      return $("#info").stop(true, true).fadeOut();
    },
    template: function(params) {
      return "<h1>" + params.title + "</h1>\n<h2>" + params.year + "</h2>\n<div class=\"text\">" + params.text + "</div>";
    }
  };

  jQuery.fn.transform = function(args) {
    return $(this).css({
      "-webkit-transform": args,
      "-moz-transform": args,
      "transform": args
    });
  };

  jQuery.fn.transformOrigin = function(args) {
    return $(this).css({
      "-webkit-transform-origin": args,
      "-moz-transform-origin": args,
      "-ms-transform-origin": args,
      "-o-transform-origin": args,
      "transform-origin": args
    });
  };

}).call(this);
